---
# common tasks for all Debian and Ubuntu machines

# #19984: Automatische Aktualisierung fuer Ubuntu Rechner: cron-apt kann genutzt werden
- name: Ensure basic packages
  apt:
    pkg:
    - cron-apt
    - etckeeper
    - git
    - lsb-release
    - patch
    - python3
    - sudo
    - vim
    - zsh
  tags: apt

- name: Ensure basic packages (remove deprecated)
  apt:
    state: absent
    pkg:
    - apt-listchanges

- name: Calcualte cron-apt setting
  set_fact:
    cron_apt_config: >-
      {% if enable_auto_update_system|default(True) 
        %}upgrade -y --with-new-pkgs -o APT::Get::Show-Upgraded=true
      {% else
        %}dist-upgrade -d -y -o APT::Get::Show-Upgraded=true
      {% endif %}

- name: Configure cron-apt
  lineinfile:
    dest: /etc/cron-apt/action.d/3-download
    regexp: Show-Upgraded=true
    line: "{{ cron_apt_config }}"
  # Raspbian reports "Debian" as ansible_distribution
  when: (ansible_distribution == "Debian")
        or (ansible_distribution == "Ubuntu" and ansible_distribution_major_version|int > 18)
    # Raspbian reports "Debian" as ansible_distribution

- name: "sudoers: mit-defaults"
  copy:
    src: sudoers.d-local-mit-dedicated
    dest: /etc/sudoers.d/local-mit-dedicated
    mode: 0440
    validate: 'visudo -cf %s'

# sudo update-alternatives --set editor /usr/bin/vim.basic
- name: "Use vim as default editor"
  alternatives:
    name: editor
    path: /usr/bin/vim.basic
  become: yes

- stat: path=/etc/aliases
  register: etc_aliases

- name: "Set mail alias for root -> {{ alias_root }}"
  lineinfile:
    dest: /etc/aliases
    create: no
    regexp: "^root:"
    line: "root: {{ alias_root }}"
  notify: newaliases
  when: etc_aliases.stat.exists
  tags: mail

- name: "Install /etc/cron.daily/local-mit-disk-info"
  copy: src=local-mit-disk-info dest=/etc/cron.daily/local-mit-disk-info mode=0755

# 2019-03-26: All external sources should now be in /etc/apt/sources.list.d/
#     in order to provide a single /etc/apt/sources.list for all machines.
- name: "Copy default /etc/apt/sources.list"
  become: yes
  copy:
    # We use this playbook for ansible_lsb.id=(Debian|Raspbian)
    src: sources.list-Linux-{{ ansible_lsb.id }}_{{ ansible_lsb.major_release }}
    dest: /etc/apt/sources.list
  when: ansible_distribution == "Debian"
  notify: Update apt cache

